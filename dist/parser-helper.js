"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.parserHelper = void 0;

var _common = require("./common");

var _emailjsImapHandler = require("emailjs-imap-handler");

const isUnexpectedCharError = e => e && e.message && e.message.toLowerCase().indexOf('unexpected char at position') !== -1; // according to the https://www.rfc-editor.org/rfc/rfc2047


const encodedWordsRegex = /=\?[^?]+\?[^?]+\?(.+?)\?=/ig;
const serverBugRegex = /(.+NO\s+\[SERVERBUG])(.+)/i;
const commandNotAllowedStringCharacter = /[^a-zA-Z-.0-9_: ]/ig;

const sanitizeEncodedWords = command => {
  const allMatches = command.matchAll(encodedWordsRegex);
  let changedCommand = command;

  for (const match of allMatches) {
    if (match.length !== 2) {
      continue;
    }

    if (match[1].indexOf('"') === -1) {
      continue;
    }

    const repl = match[1].replaceAll(/"/ig, '');
    changedCommand = changedCommand.replace(match[1], repl);
  }

  return changedCommand;
};

const sanitizeServerBug = command => {
  const foundMatch = serverBugRegex.exec(command);

  if (foundMatch.length !== 3) {
    return command;
  }

  return [foundMatch[1], foundMatch[2].replaceAll(commandNotAllowedStringCharacter, '').trim()].join(' ');
};

const parsingHacks = [{
  // parsing hack in situation when last character breaks parsing
  func: (command, opts) => (0, _emailjsImapHandler.parser)(command.slice(0, -1), opts),
  condition: (command, e) => e && e.message === `Unexpected char at position ${command.length - 1}` && typeof command.slice === 'function'
}, {
  // parsing hack which is caused by provider returning command with two sequential double quotes ""
  func: (command, opts) => (0, _emailjsImapHandler.parser)((0, _common.toTypedArray)((0, _common.fromTypedArray)(command).replaceAll(/""/ig, '"')), opts),
  condition: (command, e) => isUnexpectedCharError(e)
}, {
  // parsing hack which is caused by provider returning command with encoded-words with quotes in ATOM instructions
  func: (command, opts) => (0, _emailjsImapHandler.parser)((0, _common.toTypedArray)(sanitizeEncodedWords((0, _common.fromTypedArray)(command))), opts),
  condition: (command, e) => isUnexpectedCharError(e) && (0, _common.fromTypedArray)(command).search(encodedWordsRegex) !== -1
}, {
  // parsing hack which is caused by provider returning NO [SERVERBUG] unparseable message
  func: (command, opts) => (0, _emailjsImapHandler.parser)((0, _common.toTypedArray)(sanitizeServerBug((0, _common.fromTypedArray)(command))), opts),
  condition: (command, e) => isUnexpectedCharError(e) && (0, _common.fromTypedArray)(command).search(serverBugRegex) !== -1
}];

const parserHelper = (command, opts) => {
  try {
    return (0, _emailjsImapHandler.parser)(command, opts);
  } catch (e) {
    for (let i = 0; i < parsingHacks.length; i++) {
      const attempt = parsingHacks[i];

      if (!attempt.condition(command, e)) {
        continue;
      }

      try {
        return attempt.func(command, opts);
      } catch (e) {}
    }

    throw e;
  }
};

exports.parserHelper = parserHelper;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJpc1VuZXhwZWN0ZWRDaGFyRXJyb3IiLCJlIiwibWVzc2FnZSIsInRvTG93ZXJDYXNlIiwiaW5kZXhPZiIsImVuY29kZWRXb3Jkc1JlZ2V4Iiwic2VydmVyQnVnUmVnZXgiLCJjb21tYW5kTm90QWxsb3dlZFN0cmluZ0NoYXJhY3RlciIsInNhbml0aXplRW5jb2RlZFdvcmRzIiwiY29tbWFuZCIsImFsbE1hdGNoZXMiLCJtYXRjaEFsbCIsImNoYW5nZWRDb21tYW5kIiwibWF0Y2giLCJsZW5ndGgiLCJyZXBsIiwicmVwbGFjZUFsbCIsInJlcGxhY2UiLCJzYW5pdGl6ZVNlcnZlckJ1ZyIsImZvdW5kTWF0Y2giLCJleGVjIiwidHJpbSIsImpvaW4iLCJwYXJzaW5nSGFja3MiLCJmdW5jIiwib3B0cyIsInBhcnNlciIsInNsaWNlIiwiY29uZGl0aW9uIiwidG9UeXBlZEFycmF5IiwiZnJvbVR5cGVkQXJyYXkiLCJzZWFyY2giLCJwYXJzZXJIZWxwZXIiLCJpIiwiYXR0ZW1wdCJdLCJzb3VyY2VzIjpbIi4uL3NyYy9wYXJzZXItaGVscGVyLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHRvVHlwZWRBcnJheSwgZnJvbVR5cGVkQXJyYXkgfSBmcm9tICcuL2NvbW1vbidcbmltcG9ydCB7IHBhcnNlciB9IGZyb20gJ2VtYWlsanMtaW1hcC1oYW5kbGVyJ1xuXG5jb25zdCBpc1VuZXhwZWN0ZWRDaGFyRXJyb3IgPSBlID0+IGUgJiYgZS5tZXNzYWdlICYmIGUubWVzc2FnZS50b0xvd2VyQ2FzZSgpXG4gIC5pbmRleE9mKCd1bmV4cGVjdGVkIGNoYXIgYXQgcG9zaXRpb24nKSAhPT0gLTFcblxuLy8gYWNjb3JkaW5nIHRvIHRoZSBodHRwczovL3d3dy5yZmMtZWRpdG9yLm9yZy9yZmMvcmZjMjA0N1xuY29uc3QgZW5jb2RlZFdvcmRzUmVnZXggPSAvPVxcP1teP10rXFw/W14/XStcXD8oLis/KVxcPz0vaWdcbmNvbnN0IHNlcnZlckJ1Z1JlZ2V4ID0gLyguK05PXFxzK1xcW1NFUlZFUkJVR10pKC4rKS9pXG5jb25zdCBjb21tYW5kTm90QWxsb3dlZFN0cmluZ0NoYXJhY3RlciA9IC9bXmEtekEtWi0uMC05XzogXS9pZ1xuXG5jb25zdCBzYW5pdGl6ZUVuY29kZWRXb3JkcyA9IGNvbW1hbmQgPT4ge1xuICBjb25zdCBhbGxNYXRjaGVzID0gY29tbWFuZC5tYXRjaEFsbChlbmNvZGVkV29yZHNSZWdleClcblxuICBsZXQgY2hhbmdlZENvbW1hbmQgPSBjb21tYW5kXG5cbiAgZm9yIChjb25zdCBtYXRjaCBvZiBhbGxNYXRjaGVzKSB7XG4gICAgaWYgKG1hdGNoLmxlbmd0aCAhPT0gMikge1xuICAgICAgY29udGludWVcbiAgICB9XG5cbiAgICBpZiAobWF0Y2hbMV0uaW5kZXhPZignXCInKSA9PT0gLTEpIHtcbiAgICAgIGNvbnRpbnVlXG4gICAgfVxuXG4gICAgY29uc3QgcmVwbCA9IG1hdGNoWzFdLnJlcGxhY2VBbGwoL1wiL2lnLCAnJylcblxuICAgIGNoYW5nZWRDb21tYW5kID0gY2hhbmdlZENvbW1hbmQucmVwbGFjZShtYXRjaFsxXSwgcmVwbClcbiAgfVxuXG4gIHJldHVybiBjaGFuZ2VkQ29tbWFuZFxufVxuXG5jb25zdCBzYW5pdGl6ZVNlcnZlckJ1ZyA9IGNvbW1hbmQgPT4ge1xuICBjb25zdCBmb3VuZE1hdGNoID0gc2VydmVyQnVnUmVnZXguZXhlYyhjb21tYW5kKVxuXG4gIGlmIChmb3VuZE1hdGNoLmxlbmd0aCAhPT0gMykge1xuICAgIHJldHVybiBjb21tYW5kXG4gIH1cblxuICByZXR1cm4gW1xuICAgIGZvdW5kTWF0Y2hbMV0sXG4gICAgZm91bmRNYXRjaFsyXS5yZXBsYWNlQWxsKGNvbW1hbmROb3RBbGxvd2VkU3RyaW5nQ2hhcmFjdGVyLCAnJykudHJpbSgpXG4gIF0uam9pbignICcpXG59XG5cbmNvbnN0IHBhcnNpbmdIYWNrcyA9IFtcbiAge1xuICAgIC8vIHBhcnNpbmcgaGFjayBpbiBzaXR1YXRpb24gd2hlbiBsYXN0IGNoYXJhY3RlciBicmVha3MgcGFyc2luZ1xuICAgIGZ1bmM6IChjb21tYW5kLCBvcHRzKSA9PiBwYXJzZXIoY29tbWFuZC5zbGljZSgwLCAtMSksIG9wdHMpLFxuICAgIGNvbmRpdGlvbjogKGNvbW1hbmQsIGUpID0+IGUgJiYgZS5tZXNzYWdlID09PSBgVW5leHBlY3RlZCBjaGFyIGF0IHBvc2l0aW9uICR7Y29tbWFuZC5sZW5ndGggLSAxfWAgJiYgdHlwZW9mIGNvbW1hbmQuc2xpY2UgPT09ICdmdW5jdGlvbidcbiAgfSxcbiAge1xuICAgIC8vIHBhcnNpbmcgaGFjayB3aGljaCBpcyBjYXVzZWQgYnkgcHJvdmlkZXIgcmV0dXJuaW5nIGNvbW1hbmQgd2l0aCB0d28gc2VxdWVudGlhbCBkb3VibGUgcXVvdGVzIFwiXCJcbiAgICBmdW5jOiAoY29tbWFuZCwgb3B0cykgPT4gcGFyc2VyKHRvVHlwZWRBcnJheShmcm9tVHlwZWRBcnJheShjb21tYW5kKS5yZXBsYWNlQWxsKC9cIlwiL2lnLCAnXCInKSksIG9wdHMpLFxuICAgIGNvbmRpdGlvbjogKGNvbW1hbmQsIGUpID0+IGlzVW5leHBlY3RlZENoYXJFcnJvcihlKVxuICB9LFxuICB7XG4gICAgLy8gcGFyc2luZyBoYWNrIHdoaWNoIGlzIGNhdXNlZCBieSBwcm92aWRlciByZXR1cm5pbmcgY29tbWFuZCB3aXRoIGVuY29kZWQtd29yZHMgd2l0aCBxdW90ZXMgaW4gQVRPTSBpbnN0cnVjdGlvbnNcbiAgICBmdW5jOiAoY29tbWFuZCwgb3B0cykgPT4gcGFyc2VyKHRvVHlwZWRBcnJheShzYW5pdGl6ZUVuY29kZWRXb3Jkcyhmcm9tVHlwZWRBcnJheShjb21tYW5kKSkpLCBvcHRzKSxcbiAgICBjb25kaXRpb246IChjb21tYW5kLCBlKSA9PiBpc1VuZXhwZWN0ZWRDaGFyRXJyb3IoZSkgJiYgZnJvbVR5cGVkQXJyYXkoY29tbWFuZCkuc2VhcmNoKGVuY29kZWRXb3Jkc1JlZ2V4KSAhPT0gLTFcbiAgfSxcbiAge1xuICAgIC8vIHBhcnNpbmcgaGFjayB3aGljaCBpcyBjYXVzZWQgYnkgcHJvdmlkZXIgcmV0dXJuaW5nIE5PIFtTRVJWRVJCVUddIHVucGFyc2VhYmxlIG1lc3NhZ2VcbiAgICBmdW5jOiAoY29tbWFuZCwgb3B0cykgPT4gcGFyc2VyKHRvVHlwZWRBcnJheShzYW5pdGl6ZVNlcnZlckJ1Zyhmcm9tVHlwZWRBcnJheShjb21tYW5kKSkpLCBvcHRzKSxcbiAgICBjb25kaXRpb246IChjb21tYW5kLCBlKSA9PiBpc1VuZXhwZWN0ZWRDaGFyRXJyb3IoZSkgJiYgZnJvbVR5cGVkQXJyYXkoY29tbWFuZCkuc2VhcmNoKHNlcnZlckJ1Z1JlZ2V4KSAhPT0gLTFcbiAgfVxuXVxuXG5leHBvcnQgY29uc3QgcGFyc2VySGVscGVyID0gKGNvbW1hbmQsIG9wdHMpID0+IHtcbiAgdHJ5IHtcbiAgICByZXR1cm4gcGFyc2VyKGNvbW1hbmQsIG9wdHMpXG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBhcnNpbmdIYWNrcy5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgYXR0ZW1wdCA9IHBhcnNpbmdIYWNrc1tpXVxuXG4gICAgICBpZiAoIWF0dGVtcHQuY29uZGl0aW9uKGNvbW1hbmQsIGUpKSB7XG4gICAgICAgIGNvbnRpbnVlXG4gICAgICB9XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIHJldHVybiBhdHRlbXB0LmZ1bmMoY29tbWFuZCwgb3B0cylcbiAgICAgIH0gY2F0Y2ggKGUpIHsgfVxuICAgIH1cblxuICAgIHRocm93IGVcbiAgfVxufVxuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBRUEsTUFBTUEscUJBQXFCLEdBQUdDLENBQUMsSUFBSUEsQ0FBQyxJQUFJQSxDQUFDLENBQUNDLE9BQVAsSUFBa0JELENBQUMsQ0FBQ0MsT0FBRixDQUFVQyxXQUFWLEdBQ2xEQyxPQURrRCxDQUMxQyw2QkFEMEMsTUFDUCxDQUFDLENBRC9DLEMsQ0FHQTs7O0FBQ0EsTUFBTUMsaUJBQWlCLEdBQUcsNkJBQTFCO0FBQ0Es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